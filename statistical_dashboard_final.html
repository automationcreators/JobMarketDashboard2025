<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistical Job Market Analysis - Averages Only</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .methodology {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }
        
        .export-controls {
            background: white;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .export-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #007bff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
        }
        
        .tab:hover {
            background-color: #f8f9fa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007bff;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .chart {
            height: 500px;
            width: 100%;
            margin: 15px 0;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 10px;
            font-size: 14px;
        }
        
        .data-table {
            overflow-x: auto;
            margin: 20px 0;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .geographic-context {
            background: #e8f4fd;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
            font-size: 0.85rem;
            color: #0c5460;
        }
        
        .small-city-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #856404;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Statistical Job Market Analysis</h1>
        <p>Focus on Averages, Min, Max per Geographic Unit - NO MISLEADING TOTALS</p>
        <p>Target States: AZ, FL, TX, NV, TN, GA, NC</p>
    </div>

    <div class="methodology">
        <h3>üî¨ Methodology</h3>
        <p><strong>Key Principle:</strong> All statistics show averages, minimums, and maximums - NO job totals due to overlapping listings</p>
        <p><strong>Example:</strong> Richmond Hill shows 11 HVAC listings averaging 896 jobs = realistic estimate of 896 HVAC jobs</p>
        <p><strong>Geographic Context:</strong> Cities shown with metro area and airport proximity for realistic assessment</p>
    </div>

    <div class="export-controls">
        <button class="export-btn" onclick="exportToPDF()">üìÑ Export to PDF</button>
        <button class="export-btn" onclick="window.print()">üñ®Ô∏è Print Dashboard</button>
    </div>

    <div class="content">
        <div class="loading" id="loading">
            üîÑ Loading statistical job market data...
        </div>

        <div id="dashboard" style="display: none;">
            <!-- Category Overview -->
            <div class="section">
                <div class="section-title">üíº Job Category Statistical Overview</div>
                <div class="chart" id="categoryOverviewChart"></div>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Avg Jobs/Listing</th>
                                <th>Avg Jobs/City</th>
                                <th>Min Jobs</th>
                                <th>Max Jobs</th>
                                <th>Cities</th>
                                <th>States</th>
                            </tr>
                        </thead>
                        <tbody id="categoryOverviewTable">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Geographic Analysis Tabs -->
            <div class="section">
                <div class="section-title">üó∫Ô∏è Geographic Analysis</div>
                <div class="tabs">
                    <div class="tab active" onclick="showTab('state', this)">üìç By State</div>
                    <div class="tab" onclick="showTab('metro', this)">üèôÔ∏è By Metro Area</div>
                    <div class="tab" onclick="showTab('airport', this)">‚úàÔ∏è By Airport</div>
                    <div class="tab" onclick="showTab('concentration', this)">üìç Metro Concentration</div>
                    <div class="tab" onclick="showTab('topCities', this)">üåÜ Top 20 by Population</div>
                    <div class="tab" onclick="showTab('outsideMetros', this)">üèòÔ∏è Top 20 Outside Metros</div>
                    <div class="tab" onclick="showTab('powerCities', this)">‚≠ê Power Cities</div>
                    <div class="tab" onclick="showTab('city', this)">üìã All Cities Detail</div>
                </div>

                <!-- State Analysis Tab -->
                <div class="tab-content active" id="state-content">
                    <div class="chart" id="stateChart"></div>
                    <div class="data-table">
                        <h4>State Statistics Summary</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>State</th>
                                    <th>Cities</th>
                                    <th>Top 5 Categories</th>
                                    <th>Concentration</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="stateTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Metro Analysis Tab -->
                <div class="tab-content" id="metro-content">
                    <div class="small-city-note">
                        <strong>Metro Context:</strong> Cities like Kensington Park (pop. 4K) are grouped with their metro area to provide realistic geographic context.
                    </div>
                    <div class="controls">
                        <label>Select Metro Area: 
                            <select id="metroSelect" onchange="updateMetroDetails()">
                                <option value="">Choose a metro area...</option>
                            </select>
                        </label>
                    </div>
                    <div id="metroDetails" style="display: none;">
                        <div class="stats-grid" id="metroStats"></div>
                        <div class="chart" id="metroChart"></div>
                        <div class="data-table">
                            <h4>Metro Distance Analysis</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>All Metro</th>
                                        <th>Within 25 Miles</th>
                                        <th>Within 50 Miles</th>
                                        <th>Range (Min-Max)</th>
                                    </tr>
                                </thead>
                                <tbody id="metroTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Metro Concentration Tab -->
                <div class="tab-content" id="concentration-content">
                    <div class="small-city-note">
                        <strong>50-Mile Metro Concentration:</strong> Shows how many job listings are within 50 miles of metro centers, indicating market concentration.
                    </div>
                    <div class="chart" id="concentrationChart"></div>
                    <div class="chart" id="state-concentration-chart"></div>
                    <div class="two-column">
                        <div>
                            <h4>üìä Top Metro Areas by Market Size</h4>
                            <div class="data-table" style="max-height: 400px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Metro Area</th>
                                            <th>State</th>
                                            <th>Total Listings</th>
                                            <th>Within 50mi</th>
                                            <th>Concentration %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="concentrationTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h4>üèõÔ∏è State Concentration Summary</h4>
                            <div class="data-table" style="max-height: 400px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>State</th>
                                            <th>Concentration %</th>
                                            <th>Cities</th>
                                            <th>Metros</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stateConcentrationTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Airport Analysis Tab -->
                <div class="tab-content" id="airport-content">
                    <div class="controls">
                        <label>Select Airport: 
                            <select id="airportSelect" onchange="updateAirportDetails()">
                                <option value="">Choose an airport...</option>
                            </select>
                        </label>
                    </div>
                    <div id="airportDetails" style="display: none;">
                        <div class="stats-grid" id="airportStats"></div>
                        <div class="chart" id="airportChart"></div>
                        <div class="data-table">
                            <h4>Airport Area Job Categories</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Avg Jobs/Listing</th>
                                        <th>Min Jobs</th>
                                        <th>Max Jobs</th>
                                        <th>Cities</th>
                                        <th>Listings</th>
                                    </tr>
                                </thead>
                                <tbody id="airportTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Top Cities by Population Tab -->
                <div class="tab-content" id="topCities-content">
                    <div class="small-city-note">
                        <strong>Top 20 Cities by Population:</strong> Major metropolitan areas and largest cities in the 7-state region with job market analysis.
                    </div>
                    <div class="chart" id="topCitiesChart"></div>
                    <div class="data-table">
                        <h4>Top 20 Cities by Population - Job Market Statistics</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>City</th>
                                    <th>Population</th>
                                    <th>Metro Status</th>
                                    <th>Avg Jobs/Category</th>
                                    <th>Top 4 Categories</th>
                                </tr>
                            </thead>
                            <tbody id="topCitiesTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Outside Metro Areas Tab -->
                <div class="tab-content" id="outsideMetros-content">
                    <div class="small-city-note">
                        <strong>Top 20 Cities Outside Major Metros:</strong> Larger secondary cities not in primary metropolitan areas, providing insight into regional job markets.
                    </div>
                    
                    <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h4 style="color: #0c5460; margin-bottom: 15px;">üîç Key Insights & Takeaways</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #0c5460; line-height: 1.6;">
                            <li><strong>Healthcare Dominance:</strong> Registered Nurse leads in 10 out of 20 cities (50%), indicating strong healthcare demand in secondary markets outside major metropolitan areas.</li>
                            <li><strong>Texas Secondary Market Strength:</strong> Texas accounts for 9 of the top 20 outside metro cities, demonstrating robust regional job markets beyond Dallas-Houston-Austin triangle.</li>
                            <li><strong>Population-Performance Gap:</strong> Larger cities like El Paso (680K population) show lower job market activity (100 avg jobs/category) compared to smaller cities like Scottsdale (260K population, 422 avg jobs/category), suggesting economic specialization varies significantly.</li>
                            <li><strong>Arizona's Specialized Markets:</strong> Arizona cities (Mesa, Chandler, Scottsdale) show exceptionally high job market strength (380-422 avg jobs/category), with Speech Pathologist emerging as a unique leading category.</li>
                            <li><strong>Regional Economic Diversification:</strong> Unlike major metros dominated by tech or finance, these secondary markets show diverse leadership across healthcare (Nursing), logistics (CDL), specialized therapy (Speech Pathologist), and security services.</li>
                        </ul>
                    </div>
                    <div class="chart" id="outsideMetrosChart"></div>
                    <div class="data-table">
                        <h4>Top 20 Cities Outside Major Metro Areas - Job Market Statistics</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>City</th>
                                    <th>State</th>
                                    <th>Population</th>
                                    <th>Avg Jobs/Category</th>
                                    <th>Top 4 Categories</th>
                                </tr>
                            </thead>
                            <tbody id="outsideMetrosTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Power Cities Tab -->
                <div class="tab-content" id="powerCities-content">
                    <div class="small-city-note">
                        <strong>Power Cities Analysis:</strong> Market leaders by job category. No cities dominate across all categories - specialization is key.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0;">
                        <!-- Category Leaders -->
                        <div>
                            <h4 style="color: #007bff; margin-bottom: 15px;">üèÜ Category Leaders (#1 in Each)</h4>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table style="width: 100%; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 8px;">Category</th>
                                            <th style="padding: 8px;">Leader City</th>
                                            <th style="padding: 8px;">Avg Jobs</th>
                                        </tr>
                                    </thead>
                                    <tbody id="categoryLeadersTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Top 3 Summary -->
                        <div>
                            <h4 style="color: #007bff; margin-bottom: 15px;">üìä Market Specialization Insights</h4>
                            <div id="specializationInsights" style="font-size: 14px;">
                                <!-- Insights populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compact Top 3 Matrix -->
                    <h4 style="color: #007bff; margin: 25px 0 15px 0;">ü•áü•àü•â Top 3 Cities by Category</h4>
                    <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px;">
                        <table style="width: 100%; font-size: 12px;">
                            <thead>
                                <tr style="background: #f8f9fa; position: sticky; top: 0;">
                                    <th style="padding: 10px; text-align: left; min-width: 120px;">Category</th>
                                    <th style="padding: 10px; text-align: left; min-width: 150px;">ü•á #1 City</th>
                                    <th style="padding: 10px; text-align: left; min-width: 150px;">ü•à #2 City</th>
                                    <th style="padding: 10px; text-align: left; min-width: 150px;">ü•â #3 City</th>
                                </tr>
                            </thead>
                            <tbody id="top3MatrixTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- All City Details Tab -->
                <div class="tab-content" id="city-content">
                    <div class="controls">
                        <label>Select Category: 
                            <select id="categorySelect" onchange="updateCategoryDetails()">
                                <option value="">Choose a category...</option>
                            </select>
                        </label>
                        <label style="margin-left: 20px;">
                            <input type="checkbox" id="showMapToggle" onchange="toggleMap()"> Show Interactive Map
                        </label>
                    </div>
                    <div id="categoryDetails" style="display: none;">
                        <div class="chart" id="cityBreakdownChart"></div>
                        
                        <!-- Interactive Map -->
                        <div id="mapContainer" style="display: none; margin: 20px 0;">
                            <h4>üó∫Ô∏è Geographic Distribution - <span id="mapCategoryName"></span></h4>
                            <div id="cityMap" style="height: 500px; border-radius: 8px; border: 1px solid #ddd;"></div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <strong>Map Legend:</strong> Larger circles = more job opportunities. Click markers for details.
                            </div>
                        </div>
                        
                        <div class="data-table">
                            <h4>Detailed City Breakdown with Geographic Context</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>City</th>
                                        <th>State</th>
                                        <th>Avg Jobs</th>
                                        <th>Listings</th>
                                        <th>Min-Max</th>
                                        <th>Closest Metro</th>
                                        <th>Distance</th>
                                        <th>Airport</th>
                                    </tr>
                                </thead>
                                <tbody id="cityBreakdownTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let analysisData = {};

        async function loadData() {
            try {
                const response = await fetch('statistical_job_analysis.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                analysisData = await response.json();
                
                console.log('Loaded statistical analysis data:', analysisData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                generateDashboard();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 
                    '‚ùå Error loading statistical analysis data. Make sure the server is running and JSON file exists.';
            }
        }

        function generateDashboard() {
            console.log('üî• generateDashboard called');
            generateCategoryOverview();
            generateStateAnalysis();
            generateMetroConcentrationAnalysis();
            generateTopCitiesAnalysis();
            generateOutsideMetrosAnalysis();
            generatePowerCitiesAnalysis();
            populateSelectors();
            console.log('üî• generateDashboard completed');
        }

        function generateCategoryOverview() {
            const categories = analysisData.category_overview;
            const categoryArray = Object.entries(categories).map(([name, data]) => ({name, ...data}));
            categoryArray.sort((a, b) => b.avg_jobs_per_listing - a.avg_jobs_per_listing);
            
            // Chart showing avg jobs per listing vs avg jobs per city with better text positioning
            const chartData = [{
                x: categoryArray.map(c => c.avg_jobs_per_listing),
                y: categoryArray.map(c => c.avg_jobs_per_city),
                text: categoryArray.map(c => c.name),
                mode: 'markers',
                hovertemplate: '<b>%{text}</b><br>' +
                              'Avg Jobs per Listing: %{x}<br>' +
                              'Avg Jobs per City: %{y}<br>' +
                              '<extra></extra>',
                marker: {
                    size: 15,
                    color: categoryArray.map((c, i) => {
                        const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', 
                                      '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf', '#aec7e8'];
                        return colors[i % colors.length];
                    }),
                    line: { width: 2, color: '#333' },
                    opacity: 0.8
                },
                type: 'scatter'
            }];

            const layout = {
                title: 'Average Jobs per Listing vs Average Jobs per City<br><sub>Hover over points for category names</sub>',
                xaxis: { title: 'Average Jobs per Listing' },
                yaxis: { title: 'Average Jobs per City' },
                height: 500,
                margin: { l: 80, r: 50, t: 100, b: 80 },
                showlegend: false
            };

            Plotly.newPlot('categoryOverviewChart', chartData, layout, {responsive: true});
            
            // Add color legend table below the chart
            const legendHtml = `
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>üìä Category Color Legend</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        ${categoryArray.map((cat, i) => {
                            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', 
                                          '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf', '#aec7e8'];
                            const color = colors[i % colors.length];
                            return `<div style="display: flex; align-items: center; font-size: 0.9rem;">
                                       <div style="width: 12px; height: 12px; background: ${color}; border-radius: 50%; margin-right: 8px;"></div>
                                       <span><strong>${cat.name}</strong></span>
                                   </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Insert legend after the chart
            setTimeout(() => {
                const chartContainer = document.getElementById('categoryOverviewChart').parentNode;
                const existingLegend = chartContainer.querySelector('.category-legend');
                if (existingLegend) existingLegend.remove();
                const legendDiv = document.createElement('div');
                legendDiv.className = 'category-legend';
                legendDiv.innerHTML = legendHtml;
                chartContainer.appendChild(legendDiv);
            }, 100);
            
            // Table
            const tableHtml = categoryArray.map(cat => `
                <tr>
                    <td><strong>${cat.name}</strong></td>
                    <td>${cat.avg_jobs_per_listing}</td>
                    <td>${cat.avg_jobs_per_city}</td>
                    <td>${cat.min_jobs_per_listing}</td>
                    <td>${cat.max_jobs_per_listing}</td>
                    <td>${cat.cities_with_jobs}</td>
                    <td>${cat.states_with_jobs}</td>
                </tr>
            `).join('');
            document.getElementById('categoryOverviewTable').innerHTML = tableHtml;
        }

        function generateStateAnalysis() {
            const states = analysisData.state_statistics;
            const stateArray = Object.entries(states).map(([code, data]) => ({code, ...data}));
            
            // Get top category for each state by avg jobs per listing
            stateArray.forEach(state => {
                const categoryArray = Object.entries(state.categories);
                if (categoryArray.length > 0) {
                    const topCategory = categoryArray.reduce((prev, current) => 
                        current[1].avg_jobs_per_listing > prev[1].avg_jobs_per_listing ? current : prev
                    );
                    state.topCategory = topCategory[0];
                    state.topCategoryAvg = topCategory[1].avg_jobs_per_listing;
                    state.topCategoryAvgCity = topCategory[1].avg_jobs_per_city;
                }
            });
            
            // Chart showing total cities by state
            const chartData = [{
                x: stateArray.map(s => s.code),
                y: stateArray.map(s => s.total_cities),
                type: 'bar',
                marker: { color: '#17a2b8' },
                text: stateArray.map(s => s.total_cities),
                textposition: 'outside'
            }];

            const layout = {
                title: 'Number of Cities Analyzed by State',
                xaxis: { title: 'State' },
                yaxis: { title: 'Number of Cities' },
                height: 500
            };

            Plotly.newPlot('stateChart', chartData, layout, {responsive: true});
            
            // Add concentration data and top 3 categories to states
            stateArray.forEach(state => {
                const stateData = analysisData.state_statistics[state.code];
                state.top5Categories = stateData.top_5_categories || stateData.top_3_categories || [];
                
                // Get concentration data if available
                if (analysisData.enhanced_analysis && analysisData.enhanced_analysis.state_metro_concentration) {
                    const concentrationData = analysisData.enhanced_analysis.state_metro_concentration[state.code];
                    state.concentration = concentrationData ? concentrationData.state_concentration_percentage : 0;
                } else {
                    state.concentration = 0;
                }
            });
            
            // State table with top 5 categories
            const stateTableHtml = stateArray.map(state => `
                <tr>
                    <td><strong>${state.code}</strong></td>
                    <td>${state.total_cities}</td>
                    <td>
                        ${state.top5Categories.slice(0, 5).map((cat, i) => 
                            `${i + 1}. ${cat.category} (${cat.avg_jobs_per_listing})`
                        ).join('<br>')}
                    </td>
                    <td>${state.concentration}%</td>
                    <td>${state.total_categories} categories, ${state.total_titles} titles</td>
                </tr>
            `).join('');
            document.getElementById('stateTable').innerHTML = stateTableHtml;
        }

        function generateMetroConcentrationAnalysis() {
            console.log('generateMetroConcentrationAnalysis called, data exists:', !!analysisData.enhanced_analysis);
            if (!analysisData.enhanced_analysis) {
                console.warn('Enhanced analysis data missing');
                return;
            }
            
            const metroData = analysisData.enhanced_analysis.metro_concentration_50_miles;
            const stateData = analysisData.enhanced_analysis.state_metro_concentration;
            
            // Metro concentration chart  
            const metroArray = Array.isArray(metroData) ? metroData : Object.entries(metroData);
            const top15Metros = metroArray.slice(0, 15);
            const chartData = [{
                x: top15Metros.map(([metro]) => metro),
                y: top15Metros.map(([, data]) => data.concentration_percentage),
                type: 'bar',
                marker: { color: '#17a2b8' },
                text: top15Metros.map(([, data]) => `${data.concentration_percentage}%`),
                textposition: 'outside'
            }];

            const layout = {
                title: 'Metro Area Job Concentration (% within 50 miles)',
                xaxis: { 
                    tickangle: -45,
                    title: 'Metro Area'
                },
                yaxis: { title: 'Concentration Percentage' },
                height: 500,
                margin: { b: 120 }
            };

            Plotly.newPlot('concentrationChart', chartData, layout, {responsive: true});
            
            // Metro table
            const metroTableHtml = top15Metros.map(([metro, data]) => `
                <tr>
                    <td><strong>${metro}</strong></td>
                    <td>${data.state}</td>
                    <td>${data.total_listings.toLocaleString()}</td>
                    <td>${data.within_50_total.toLocaleString()}</td>
                    <td>${data.concentration_percentage}%</td>
                </tr>
            `).join('');
            document.getElementById('concentrationTable').innerHTML = metroTableHtml;
            
            // State concentration chart
            const stateArray = Object.entries(stateData)
                .sort((a, b) => b[1].state_concentration_percentage - a[1].state_concentration_percentage);
            
            const stateChartData = [{
                x: stateArray.map(([state]) => state),
                y: stateArray.map(([, data]) => data.state_concentration_percentage),
                type: 'bar',
                marker: { color: '#28a745' },
                text: stateArray.map(([, data]) => data.state_concentration_percentage + '%'),
                textposition: 'outside'
            }];

            const stateLayout = {
                title: 'State Metro Concentration (50-Mile)',
                xaxis: { title: 'State' },
                yaxis: { title: 'Concentration Percentage' },
                height: 400,
                margin: { l: 80, r: 50, t: 80, b: 80 }
            };

            Plotly.newPlot('state-concentration-chart', stateChartData, stateLayout, {responsive: true});
            
            // State concentration table
            const stateTableHtml = Object.entries(stateData)
                .sort((a, b) => b[1].state_concentration_percentage - a[1].state_concentration_percentage)
                .map(([state, data]) => `
                    <tr>
                        <td><strong>${state}</strong></td>
                        <td>${data.state_concentration_percentage}%</td>
                        <td>${data.total_cities}</td>
                        <td>${data.total_metros}</td>
                    </tr>
                `).join('');
            document.getElementById('stateConcentrationTable').innerHTML = stateTableHtml;
        }

        function generateTopCitiesAnalysis() {
            console.log('generateTopCitiesAnalysis called, data exists:', !!analysisData.focused_city_analysis);
            if (!analysisData.focused_city_analysis) {
                console.warn('Focused city analysis data missing');
                return;
            }
            
            const topCities = analysisData.focused_city_analysis.top_20_by_population;
            const cityArray = Object.entries(topCities).map(([name, data]) => ({name, ...data}));
            
            // Sort by population
            cityArray.sort((a, b) => b.population - a.population);
            
            // Add top 4 categories for each city
            cityArray.forEach(city => {
                const categories = Object.entries(city.job_categories);
                if (categories.length > 0) {
                    // Sort categories by avg_jobs_per_listing and get top 4
                    const sortedCategories = categories.sort((a, b) => 
                        b[1].avg_jobs_per_listing - a[1].avg_jobs_per_listing
                    );
                    
                    // Create top 4 categories list
                    city.top4Categories = sortedCategories.slice(0, 4).map((cat, index) => 
                        `${index + 1}. ${cat[0]} (${cat[1].avg_jobs_per_listing.toFixed(1)})`
                    ).join('<br>');
                    
                    // Keep top category for backward compatibility
                    const topCategory = sortedCategories[0];
                    city.topCategory = topCategory[0];
                    city.topCategoryAvg = topCategory[1].avg_jobs_per_listing;
                }
            });
            
            // Chart showing population vs avg jobs per category
            const chartData = [{
                x: cityArray.map(c => c.population),
                y: cityArray.map(c => c.avg_jobs_across_categories),
                text: cityArray.map(c => c.name),
                mode: 'markers+text',
                textposition: 'top center',
                marker: {
                    size: 12,
                    color: cityArray.map(c => c.is_major_metro ? '#007bff' : '#fd7e14'),
                    line: { width: 2, color: '#333' }
                },
                type: 'scatter'
            }];

            const layout = {
                title: 'Population vs Average Jobs per Category (Blue = Major Metro, Orange = Secondary)',
                xaxis: { 
                    title: 'Population',
                    type: 'log'
                },
                yaxis: { title: 'Average Jobs per Category' },
                height: 500,
                margin: { l: 80, r: 50, t: 80, b: 80 }
            };

            Plotly.newPlot('topCitiesChart', chartData, layout, {responsive: true});
            
            // Table
            const tableHtml = cityArray.map((city, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${city.name}</strong></td>
                    <td>${city.population.toLocaleString()}</td>
                    <td>${city.is_major_metro ? 'Major Metro' : 'Secondary'}</td>
                    <td>${city.avg_jobs_across_categories.toFixed(1)}</td>
                    <td>${city.top4Categories || 'N/A'}</td>
                </tr>
            `).join('');
            document.getElementById('topCitiesTable').innerHTML = tableHtml;
            console.log('‚úÖ Top Cities table updated with', cityArray.length, 'cities');
        }

        function generateOutsideMetrosAnalysis() {
            console.log('generateOutsideMetrosAnalysis called, data exists:', !!analysisData.focused_city_analysis);
            if (!analysisData.focused_city_analysis) {
                console.warn('Focused city analysis data missing');
                return;
            }
            
            const outsideCities = analysisData.focused_city_analysis.top_20_outside_major_metros;
            const cityArray = Object.entries(outsideCities).map(([name, data]) => ({name, ...data}));
            
            // Sort by population
            cityArray.sort((a, b) => b.population - a.population);
            
            // Add state and top 4 categories for each city
            cityArray.forEach(city => {
                // Get state from job categories data
                const firstCategory = Object.values(city.job_categories)[0];
                city.state = firstCategory ? firstCategory.state : 'Unknown';
                
                const categories = Object.entries(city.job_categories);
                if (categories.length > 0) {
                    // Sort categories by avg_jobs_per_listing and get top 4
                    const sortedCategories = categories.sort((a, b) => 
                        b[1].avg_jobs_per_listing - a[1].avg_jobs_per_listing
                    );
                    
                    // Create top 4 categories list
                    city.top4Categories = sortedCategories.slice(0, 4).map((cat, index) => 
                        `${index + 1}. ${cat[0]} (${cat[1].avg_jobs_per_listing.toFixed(1)})`
                    ).join('<br>');
                    
                    // Keep top category for backward compatibility
                    city.topCategory = sortedCategories[0][0];
                    city.topCategoryAvg = sortedCategories[0][1].avg_jobs_per_listing;
                }
            });
            
            // Chart showing population vs job market strength for outside metro cities
            const chartData = [{
                x: cityArray.map(c => c.name),
                y: cityArray.map(c => c.avg_jobs_across_categories),
                type: 'bar',
                marker: { 
                    color: '#20c997',
                    line: { color: '#17a2b8', width: 1 }
                },
                text: cityArray.map(c => c.avg_jobs_across_categories.toFixed(1)),
                textposition: 'outside'
            }];

            const layout = {
                title: 'Job Market Strength in Cities Outside Major Metro Areas',
                xaxis: { 
                    tickangle: -45,
                    title: 'City'
                },
                yaxis: { title: 'Average Jobs per Category' },
                height: 500,
                margin: { l: 80, r: 50, t: 80, b: 120 }
            };

            Plotly.newPlot('outsideMetrosChart', chartData, layout, {responsive: true});
            
            // Table
            const tableHtml = cityArray.map((city, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${city.name}</strong></td>
                    <td>${city.state}</td>
                    <td>${city.population.toLocaleString()}</td>
                    <td>${city.avg_jobs_across_categories.toFixed(1)}</td>
                    <td>${city.top4Categories || 'N/A'}</td>
                </tr>
            `).join('');
            document.getElementById('outsideMetrosTable').innerHTML = tableHtml;
            console.log('‚úÖ Outside Metros table updated with', cityArray.length, 'cities');
        }

        function generatePowerCitiesAnalysis() {
            console.log('generatePowerCitiesAnalysis called, data exists:', !!analysisData.power_cities_analysis);
            if (!analysisData.power_cities_analysis) {
                console.warn('Power cities analysis data missing');
                return;
            }
            
            const powerData = analysisData.power_cities_analysis;
            const categoryLeaders = powerData.category_leaders;
            const top3ByCategory = powerData.top_3_by_category;
            
            // Category Leaders Table
            const leadersHtml = Object.entries(categoryLeaders).map(([category, leader]) => `
                <tr>
                    <td style="padding: 8px;"><strong>${category}</strong></td>
                    <td style="padding: 8px;">${leader.city}, ${leader.state}</td>
                    <td style="padding: 8px;">${leader.avg_jobs.toFixed(0)}</td>
                </tr>
            `).join('');
            document.getElementById('categoryLeadersTable').innerHTML = leadersHtml;
            console.log('‚úÖ Power Cities table updated with', Object.keys(categoryLeaders).length, 'categories');
            
            // Specialization Insights
            const insights = `
                <div style="background: #e8f4fd; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h5 style="color: #0c5460; margin-bottom: 10px;">üéØ Key Findings</h5>
                    <ul style="margin: 0; padding-left: 20px; color: #0c5460;">
                        <li><strong>No Dominant Cities:</strong> No city appears in top 3 for 8+ categories</li>
                        <li><strong>Regional Specialization:</strong> Each category has different leaders</li>
                        <li><strong>Georgia Strong:</strong> GA cities lead in 5 categories</li>
                        <li><strong>Small City Leaders:</strong> Many #1 cities are smaller/suburban areas</li>
                    </ul>
                </div>
                
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    <h5 style="color: #495057; margin-bottom: 8px;">üèõÔ∏è State Distribution</h5>
                    <div style="font-size: 13px; color: #6c757d;">
                        <strong>Georgia:</strong> 5 category leaders<br>
                        <strong>Florida:</strong> 4 category leaders<br>
                        <strong>Texas:</strong> 2 category leaders<br>
                        <strong>Tennessee:</strong> 1 category leader<br>
                        <strong>Arizona:</strong> 1 category leader
                    </div>
                </div>
            `;
            document.getElementById('specializationInsights').innerHTML = insights;
            
            // Top 3 Matrix Table
            const matrixHtml = Object.entries(top3ByCategory).map(([category, cities]) => {
                const formatCity = (city, rank) => {
                    if (!city) return '<span style="color: #999;">-</span>';
                    const icon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : 'ü•â';
                    return `${icon} <strong>${city.city}, ${city.state}</strong><br><small>${city.avg_jobs.toFixed(0)} avg jobs</small>`;
                };
                
                return `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px; font-weight: bold; background: #f8f9fa;">${category}</td>
                        <td style="padding: 12px;">${formatCity(cities[0], 1)}</td>
                        <td style="padding: 12px;">${formatCity(cities[1], 2)}</td>
                        <td style="padding: 12px;">${formatCity(cities[2], 3)}</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('top3MatrixTable').innerHTML = matrixHtml;
        }

        function populateSelectors() {
            // Metro selector
            const metroSelect = document.getElementById('metroSelect');
            if (analysisData.metro_area_statistics) {
                Object.keys(analysisData.metro_area_statistics).sort().forEach(metro => {
                const option = document.createElement('option');
                option.value = metro;
                option.textContent = metro;
                metroSelect.appendChild(option);
                });
            }
            
            // Airport selector
            const airportSelect = document.getElementById('airportSelect');
            if (analysisData.airport_proximity_statistics) {
                Object.keys(analysisData.airport_proximity_statistics).sort().forEach(airport => {
                const option = document.createElement('option');
                option.value = airport;
                option.textContent = airport;
                airportSelect.appendChild(option);
                });
            }
            
            // Category selector
            const categorySelect = document.getElementById('categorySelect');
            if (analysisData.detailed_city_breakdown) {
                Object.keys(analysisData.detailed_city_breakdown).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
                });
            }
        }

        function showTab(tabName, clickedElement) {
            console.log('üî• showTab called for:', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
                console.log('‚úÖ Activated tab content:', tabName + '-content');
                
                // Regenerate content for specific tabs that might need it
                setTimeout(() => {
                    if (tabName === 'powerCities' && analysisData.power_cities_analysis) {
                        console.log('üîÑ Regenerating Power Cities content...');
                        generatePowerCitiesAnalysis();
                    } else if (tabName === 'topCities' && analysisData.focused_city_analysis) {
                        console.log('üîÑ Regenerating Top Cities content...');
                        generateTopCitiesAnalysis();
                    } else if (tabName === 'outsideMetros' && analysisData.focused_city_analysis) {
                        console.log('üîÑ Regenerating Outside Metros content...');
                        generateOutsideMetrosAnalysis();
                    } else if (tabName === 'concentration' && analysisData.enhanced_analysis) {
                        console.log('üîÑ Regenerating Metro Concentration content...');
                        generateMetroConcentrationAnalysis();
                    }
                }, 100);
            } else {
                console.error('‚ùå Tab content not found:', tabName + '-content');
            }
            
            // Add active class to clicked tab
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function updateMetroDetails() {
            const metro = document.getElementById('metroSelect').value;
            if (!metro) {
                document.getElementById('metroDetails').style.display = 'none';
                return;
            }
            
            document.getElementById('metroDetails').style.display = 'block';
            
            const metroData = analysisData.metro_statistics[metro];
            const categories = Object.entries(metroData.categories);
            
            // Metro stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${metroData.state}</div>
                    <div class="stat-label">State</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${metroData.total_cities}</div>
                    <div class="stat-label">Cities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${categories.length}</div>
                    <div class="stat-label">Job Categories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${metroData.total_listings}</div>
                    <div class="stat-label">Total Listings</div>
                </div>
            `;
            document.getElementById('metroStats').innerHTML = statsHtml;
            
            // Metro chart
            const top10Categories = categories
                .sort((a, b) => b[1].avg_jobs_per_listing - a[1].avg_jobs_per_listing)
                .slice(0, 10);
            
            const metroChartData = [{
                x: top10Categories.map(([cat]) => cat),
                y: top10Categories.map(([, data]) => data.avg_jobs_per_listing),
                type: 'bar',
                marker: { color: '#28a745' },
                text: top10Categories.map(([, data]) => data.avg_jobs_per_listing.toFixed(1)),
                textposition: 'outside'
            }];

            const metroLayout = {
                title: `Top Job Categories in ${metro}`,
                xaxis: { tickangle: -45 },
                yaxis: { title: 'Average Jobs per Listing' },
                height: 400,
                margin: { b: 120 }
            };

            Plotly.newPlot('metroChart', metroChartData, metroLayout, {responsive: true});
            
            // Metro table
            const metroTableHtml = categories.map(([category, data]) => `
                <tr>
                    <td><strong>${category}</strong></td>
                    <td>${data.avg_jobs_per_listing} (${data.all_listings} listings)</td>
                    <td>${data.within_25_miles.avg_jobs} (${data.within_25_miles.listings} listings, ${data.within_25_miles.cities} cities)</td>
                    <td>${data.within_50_miles.avg_jobs} (${data.within_50_miles.listings} listings, ${data.within_50_miles.cities} cities)</td>
                    <td>${data.min_jobs} - ${data.max_jobs}</td>
                </tr>
            `).join('');
            document.getElementById('metroTable').innerHTML = metroTableHtml;
        }

        function updateAirportDetails() {
            const airport = document.getElementById('airportSelect').value;
            if (!airport) {
                document.getElementById('airportDetails').style.display = 'none';
                return;
            }
            
            document.getElementById('airportDetails').style.display = 'block';
            
            const airportData = analysisData.airport_statistics[airport];
            const categories = Object.entries(airportData.categories);
            
            // Airport stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${airport}</div>
                    <div class="stat-label">Airport Code</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${airportData.state}</div>
                    <div class="stat-label">State</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${airportData.total_cities}</div>
                    <div class="stat-label">Cities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${categories.length}</div>
                    <div class="stat-label">Job Categories</div>
                </div>
            `;
            document.getElementById('airportStats').innerHTML = statsHtml;
            
            // Airport chart
            const topCategories = categories
                .sort((a, b) => b[1].avg_jobs_per_listing - a[1].avg_jobs_per_listing)
                .slice(0, 10);
            
            const airportChartData = [{
                x: topCategories.map(([cat]) => cat),
                y: topCategories.map(([, data]) => data.avg_jobs_per_listing),
                type: 'bar',
                marker: { color: '#fd7e14' },
                text: topCategories.map(([, data]) => data.avg_jobs_per_listing.toFixed(1)),
                textposition: 'outside'
            }];

            const airportLayout = {
                title: `Job Categories near ${airport} Airport`,
                xaxis: { tickangle: -45 },
                yaxis: { title: 'Average Jobs per Listing' },
                height: 400,
                margin: { b: 120 }
            };

            Plotly.newPlot('airportChart', airportChartData, airportLayout, {responsive: true});
            
            // Airport table
            const airportTableHtml = categories.map(([category, data]) => `
                <tr>
                    <td><strong>${category}</strong></td>
                    <td>${data.avg_jobs_per_listing}</td>
                    <td>${data.min_jobs}</td>
                    <td>${data.max_jobs}</td>
                    <td>${data.cities_count}</td>
                    <td>${data.listings_count}</td>
                </tr>
            `).join('');
            document.getElementById('airportTable').innerHTML = airportTableHtml;
        }

        function updateCategoryDetails() {
            const category = document.getElementById('categorySelect').value;
            if (!category) {
                document.getElementById('categoryDetails').style.display = 'none';
                return;
            }
            
            document.getElementById('categoryDetails').style.display = 'block';
            
            const categoryData = analysisData.detailed_city_breakdown[category];
            const cities = Object.entries(categoryData).sort((a, b) => b[1].avg_jobs_per_listing - a[1].avg_jobs_per_listing);
            
            // City breakdown chart
            const top20Cities = cities.slice(0, 20);
            
            const cityChartData = [{
                x: top20Cities.map(([city]) => city),
                y: top20Cities.map(([, data]) => data.avg_jobs_per_listing),
                type: 'bar',
                marker: { color: '#6f42c1' },
                text: top20Cities.map(([, data]) => Math.round(data.avg_jobs_per_listing)),
                textposition: 'outside'
            }];

            const cityLayout = {
                title: `Top 20 Cities for ${category}`,
                xaxis: { 
                    tickangle: -45,
                    title: 'City'
                },
                yaxis: { title: 'Average Jobs per Listing' },
                height: 500,
                margin: { b: 120 }
            };

            Plotly.newPlot('cityBreakdownChart', cityChartData, cityLayout, {responsive: true});
            
            // City table with geographic context
            const cityTableHtml = cities.slice(0, 50).map(([city, data]) => `
                <tr>
                    <td><strong>${city}</strong></td>
                    <td>${data.state}</td>
                    <td>${Math.round(data.avg_jobs_per_listing)}</td>
                    <td>${data.listings_count}</td>
                    <td>${data.min_jobs} - ${data.max_jobs}</td>
                    <td>${data.closest_metro || 'N/A'}</td>
                    <td>${data.metro_distance_band || 'N/A'}</td>
                    <td>${data.closest_airport || 'N/A'}</td>
                </tr>
            `).join('');
            document.getElementById('cityBreakdownTable').innerHTML = cityTableHtml;
        }

        async function exportToPDF() {
            alert('PDF export functionality available - would generate comprehensive statistical job market report');
        }

        // Load data when page loads
        window.addEventListener('load', loadData);
    </script>
</body>
</html>